<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการสั่งซื้อ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

    <div class="max-w-4xl mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">ประวัติการสั่งซื้อ</h1>

        <div id="order-history-container" class="space-y-6">
            <p id="loading-text" class="text-center text-gray-500">กำลังโหลดข้อมูล...</p>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadOrderHistory();
        });

        async function loadOrderHistory() {
            const container = document.getElementById("order-history-container");
            const loadingText = document.getElementById("loading-text");

            try {
                // 1. ดึงข้อมูลจาก API 
                const res = await fetch("/api/orders/history", { credentials: "include" });

                if (!res.ok) {
                    throw new Error("ไม่สามารถดึงข้อมูลประวัติการสั่งซื้อได้");
                }

                const orders = await res.json(); // นี่คือ Array ที่คุณส่งมา
                loadingText.remove(); 

                // 2. ตรวจสอบว่ามีรายการสั่งซื้อหรือไม่
                if (orders.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">คุณยังไม่มีประวัติการสั่งซื้อ</p>`;
                    return;
                }

                // 3. วนลูปสร้างการ์ดสำหรับแต่ละ Order
                orders.forEach(order => {
                    const orderCard = document.createElement("div");
                    orderCard.className = "bg-white shadow-lg rounded-lg overflow-hidden border border-gray-200";

                    // 3.1 คำนวณราคารวมของ Order นี้
                    const orderTotal = order.items.reduce((sum, item) => {
                        return sum + (item.price * item.quantity);
                    }, 0);

                    // 3.2 แปลงวันที่ให้อ่านง่าย
                    const orderDate = new Date(order.createdAt).toLocaleDateString('th-TH', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // 3.3 สร้าง HTML สำหรับสินค้า (Items) ใน Order นี้
                    const itemsHtml = order.items.map(item => {
                        const itemTotal = item.price * item.quantity;
                        const imageUrl = item.shirt.shirt_image || 'https://placehold.co/100x100.png'; // ภาพตัวอย่าง

                        return `
                    <div class="flex items-center gap-4 py-3">
                        <img src="${imageUrl}" alt="${item.shirt.shirt_name}" class="w-16 h-16 object-cover rounded-md bg-gray-100">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900">${item.shirt.shirt_name}</p>
                            <p class="text-sm text-gray-600">ขนาด: ${item.size}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-900">${itemTotal.toFixed(2)}฿</p>
                            <p class="text-sm text-gray-500">จำนวน: ${item.quantity}</p>
                        </div>
                    </div>
                `;
                    }).join(''); // .join('') เพื่อรวม Array ของ HTML string ให้เป็นก้อนเดียว

                    // 3.4 ประกอบร่างการ์ด Order
                    orderCard.innerHTML = `
                <div class="bg-gray-50 p-4 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">คำสั่งซื้อ #${order.id}</h2>
                        <p class="text-sm text-gray-500">วันที่: ${orderDate}</p>
                    </div>
                    <span classclass="capitalize bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${order.status}</span>
                </div>

                <div class="p-4 divide-y divide-gray-200">
                    ${itemsHtml}
                </div>

                <div class="bg-gray-50 p-4 border-t border-gray-200 text-right">
                    <span class="text-sm text-gray-600">ยอดรวม: </span>
                    <span class="text-xl font-bold text-gray-900">${orderTotal.toFixed(2)}฿</span>
                </div>
            `;

                    // 4. เพิ่มการ์ดลงในหน้าเว็บ
                    container.appendChild(orderCard);
                });

            } catch (err) {
                console.error(err);
                loadingText.remove();
                container.innerHTML = `<p class="text-center text-red-500">เกิดข้อผิดพลาด: ${err.message}</p>`;
            }
        }
    </script>
</body>

</html>
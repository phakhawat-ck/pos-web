<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Order Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body class="bg-gray-100">

    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Admin)</h1>

        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table class="min-w-full leading-normal">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th
                            class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">
                            Order ID</th>
                        <th
                            class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">
                            ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                        <th
                            class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</th>
                        <th
                            class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">
                            ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                        <th
                            class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">
                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th
                            class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">
                            ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    <tr>
                        <td colspan="6" class="text-center p-5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="orderModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modalTitle" class="text-2xl font-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Order #</h3>
                <button id="closeModalBtn" class="text-black text-2xl">&times;</button>
            </div>

            <div id="modalBody" class="py-4 space-y-4">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏Å‡πà‡∏≠‡∏ô
            checkAdminSession();

            const modal = document.getElementById("orderModal");
            const closeModalBtn = document.getElementById("closeModalBtn");

            closeModalBtn.addEventListener("click", () => modal.classList.add("hidden"));
        });

        async function checkAdminSession() {
            try {
                const res = await fetch("/api/check-session", { credentials: "include" });
                const data = await res.json();

                if (!data.user || data.user.role !== "admin") {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin, ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
                    window.location.href = "/";
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin, ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Order
                    loadAdminOrders();
                }
            } catch (err) {
                window.location.href = "/";
            }
        }

        async function loadAdminOrders() {
            const tbody = document.getElementById("orders-table-body");
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

            try {
                const res = await fetch("/api/admin/orders", { credentials: "include" });
                if (!res.ok) throw new Error("Failed to fetch orders");

                const orders = await res.json();
                tbody.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const tr = document.createElement("tr");
                    tr.className = "border-b border-gray-200 hover:bg-gray-100";

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°
                    const total = order.items.reduce((sum, i) => sum + i.price * i.quantity, 0);

                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    const date = new Date(order.createdAt).toLocaleDateString('th-TH', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    });

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    let statusButtonHtml;
                    if (order.status === 'success') {
                        statusButtonHtml = `
                    <button class="mark-shipped-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded" data-id="${order.id}">
                        <i class="fa-solid fa-box"></i> Mark as Shipped
                    </button>`;
                    } else if (order.status === 'shipped') {
                        statusButtonHtml = `<span class="text-green-600 font-semibold"><i class="fa-solid fa-circle-check"></i> Shipped</span>`;
                    } else {
                        statusButtonHtml = `<span class="text-gray-500">${order.status}</span>`;
                    }

                    tr.innerHTML = `
                <td class="px-5 py-4 text-sm">${order.id}</td>
                <td class="px-5 py-4 text-sm">${order.user.username} (ID: ${order.user.id})</td>
                <td class="px-5 py-4 text-sm">${date}</td>
                <td class="px-5 py-4 text-sm">${total.toFixed(2)}‡∏ø</td>
                <td class="px-5 py-4 text-sm font-medium" id="status-cell-${order.id}">${statusButtonHtml}</td>
                <td class="px-5 py-4 text-sm">
                    <button class="view-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded" data-order='${JSON.stringify(order)}'>
                        <i class="fa-solid fa-eye"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                </td>
            `;
                    tbody.appendChild(tr);
                });

                // üîπ ‡∏ú‡∏π‡∏Å Event (Event Delegation)
                addTableEventListeners();

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center p-5 text-red-500">Error: ${err.message}</td></tr>`;
            }
        }

        function addTableEventListeners() {
            const tbody = document.getElementById("orders-table-body");

            tbody.addEventListener("click", (e) => {
                // 1. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "View"
                const viewBtn = e.target.closest(".view-btn");
                if (viewBtn) {
                    const orderData = JSON.parse(viewBtn.dataset.order);
                    showOrderModal(orderData);
                    return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                }

                // 2. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "Mark as Shipped"
                const shipBtn = e.target.closest(".mark-shipped-btn");
                if (shipBtn) {
                    const orderId = shipBtn.dataset.id;
                    if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á Order #${orderId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        markOrderAsShipped(orderId);
                    }
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Modal
        async function showOrderModal(order) {
            const modal = document.getElementById("orderModal");
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalBody");

            modalTitle.textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Order #${order.id} (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${order.user.username})`;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const itemsHtml = order.items.map(item => `
        <div class="flex items-center gap-4 border-b pb-2">
            <img src="${item.shirt.shirt_image || 'https://placehold.co/80x80'}" alt="${item.shirt.shirt_name}" class="w-20 h-20 object-cover rounded">
            <div>
                <p class="font-bold">${item.shirt.shirt_name}</p>
                <p class="text-sm text-gray-600">‡∏Ç‡∏ô‡∏≤‡∏î: ${item.size}</p>
                <p class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity} x ${item.price}‡∏ø</p>
            </div>
            <p class="ml-auto font-semibold">${(item.quantity * item.price).toFixed(2)}‡∏ø</p>
        </div>
    `).join("");

            // --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á User ---
            // (‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á fetch ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏¢‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ include ‡∏°‡∏≤‡πÉ‡∏ô /api/admin/orders)
            let addressHtml = `<p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà...</p>`;
            modalBody.innerHTML = `<div><h4 class="font-bold text-lg mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>${itemsHtml}</div>
                         <div><h4 class="font-bold text-lg mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h4><div id="modal-address">${addressHtml}</div></div>`;

            modal.classList.remove("hidden"); // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

            // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
            // ... ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô showOrderModal(order) ...

            try {
                // ‚¨áÔ∏è ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚¨áÔ∏è
                // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á Order
                const addrRes = await fetch(`/api/admin/address/${order.userId}`, {
                    credentials: "include"
                });
                // ‚¨ÜÔ∏è ---------------- ‚¨ÜÔ∏è

                if (!addrRes.ok) {
                    const err = await addrRes.json();
                    throw new Error(err.error || "Address not found");
                }

                const address = await addrRes.json();

                // (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ model address ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ field ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ)
                addressHtml = `
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</strong> ${address.fullName || "-"}</p>
        <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${address.house_number || "-"}, ${address.street || "-"}</p>
        <p><strong>‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</strong> ${address.city || "-"}</p>
        <p><strong>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏£‡∏´‡∏±‡∏™ ‡∏õ‡∏ì.:</strong> ${address.province || "-"} ${address.zipCode || "-"}</p>
        <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${address.phone || "-"}</p>
    `;

                document.getElementById("modal-address").innerHTML = addressHtml;

            } catch (err) {
                document.getElementById("modal-address").innerHTML = `<p class="text-red-500">(${err.message})</p>`;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Shipped
        async function markOrderAsShipped(orderId) {
            try {
                const res = await fetch(`/api/admin/orders/${orderId}/status`, {
                    method: "PUT",
                    credentials: "include",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: "shipped" }) // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || "Update failed");
                }

                alert(`Order #${orderId} ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô Shipped!`);

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤)
                const statusCell = document.getElementById(`status-cell-${orderId}`);
                if (statusCell) {
                    statusCell.innerHTML = `<span class="text-green-600 font-semibold"><i class="fa-solid fa-circle-check"></i> Shipped</span>`;
                }

            } catch (err) {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            }
        }
    </script>
</body>

</html>